# Bug B09: Unsafe Repo Name Extraction

## Severity
**Medium Priority**

## Location
`src/worktreeflow/wtf.py:577`

## Description
The code splits `upstream_repo` on "/" without validating that a slash exists, which could raise an IndexError if the upstream repo is malformed.

## Current Code
```python
def fork_setup(self) -> None:
    """
    Create fork if needed and set up remotes.
    ...
    """
    # ... earlier code ...

    # Extract repo name from upstream
    repo_name = self.upstream_repo.split("/")[1]  # <-- Could raise IndexError

    # Check if fork exists
    fork_check_cmd = f'gh repo view "{github_user}/{repo_name}" --json name 2>/dev/null'
```

## Problem
If `self.upstream_repo` doesn't contain a slash (malformed value), accessing `split("/")[1]` will raise:

```python
IndexError: list index out of range
```

### How this could happen:
1. User manually sets invalid upstream: `wtf upstream-add badrepo`
2. Malformed remote URL is parsed incorrectly
3. Configuration file contains invalid value
4. Edge case in upstream detection logic

### Example:
```python
upstream_repo = "humanlayer"  # Missing /repo part
repo_name = upstream_repo.split("/")[1]  # IndexError!
```

## Impact
- **Application crash** with unhelpful error message
- No guidance on what went wrong
- User confusion about correct format

## Current Validation
The `upstream_add()` function does validate the format at line 488:
```python
if repo_upstream:
    # Validate format
    if not re.match(r'^[^/]+/[^/]+$', repo_upstream):
        raise ValueError(f"REPO_UPSTREAM must be in 'owner/repo' format. Got: '{repo_upstream}'")
    self.upstream_repo = repo_upstream
```

However, `upstream_repo` could still be set to an invalid value through:
- Direct attribute assignment
- Malformed URL parsing in `_detect_upstream_repo()`
- The hardcoded `DEFAULT_UPSTREAM_REPO` being changed incorrectly

## Proposed Fix

### Option 1: Validate before split
```python
# Extract repo name from upstream
if "/" not in self.upstream_repo:
    console.print("[red]ERROR: Invalid upstream repo format[/red]")
    console.print(f"Expected format: owner/repo, got: {self.upstream_repo}")
    console.print("Fix with: wtf upstream-add owner/repo")
    sys.exit(1)

repo_name = self.upstream_repo.split("/")[1]
```

### Option 2: Use safe parsing with error handling
```python
# Extract repo name from upstream
try:
    owner, repo_name = self.upstream_repo.split("/")
except ValueError:
    console.print("[red]ERROR: Invalid upstream repo format[/red]")
    console.print(f"Expected format: owner/repo, got: '{self.upstream_repo}'")
    console.print("Fix with: wtf upstream-add owner/repo")
    sys.exit(1)
```

### Option 3: Create a validation method
```python
def _validate_repo_format(self, repo_string: str) -> tuple[str, str]:
    """
    Validate and parse repo string in 'owner/repo' format.

    Returns:
        Tuple of (owner, repo_name)

    Raises:
        ValueError: If format is invalid
    """
    if not re.match(r'^[^/]+/[^/]+$', repo_string):
        raise ValueError(
            f"Invalid repository format: '{repo_string}'\n"
            f"Expected format: owner/repo (e.g., 'torvalds/linux')"
        )

    owner, repo_name = repo_string.split("/", 1)
    return owner, repo_name

# Then use it:
try:
    owner, repo_name = self._validate_repo_format(self.upstream_repo)
except ValueError as e:
    console.print(f"[red]ERROR: {e}[/red]")
    console.print("Fix with: wtf upstream-add owner/repo")
    sys.exit(1)
```

## Related Issues
Search for other instances of:
- `split("/")` without validation
- `split()[index]` without bounds checking
- Direct string indexing without length checks

Found at:
- Line 368: `match.group(1)` in URL parsing (protected by regex match)
- Line 390: `match.group(1)` in URL parsing (protected by regex match)

## Recommendation
**Option 2** (safe parsing with try/except) is cleanest for this specific location.

Additionally, consider adding validation in `_detect_upstream_repo()` to ensure `self.upstream_repo` is always valid format or None:

```python
def _detect_upstream_repo(self) -> None:
    """Detect upstream repository from remote."""
    self.upstream_repo = RepoConfig.DEFAULT_UPSTREAM_REPO

    if RepoConfig.UPSTREAM_REMOTE in self.repo.remotes:
        upstream_url = self.repo.remote("upstream").url
        self.logger.log("git remote get-url upstream", "Get upstream URL")

        match = re.search(r'(?:github\.com[:/])([^/]+/[^/.]+)', upstream_url)
        if match:
            detected_repo = match.group(1).replace(".git", "")
            # Validate format before setting
            if re.match(r'^[^/]+/[^/]+$', detected_repo):
                self.upstream_repo = detected_repo
            else:
                console.print(f"[yellow]Warning: Detected invalid upstream format: {detected_repo}[/yellow]")
```

This prevents invalid values from ever being set.
